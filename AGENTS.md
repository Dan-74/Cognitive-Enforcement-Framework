
title: "ToolAgent Specification - Superset Orchestrator (ONU/NIST/WB 2025+ Edition)"
version: "2025.10.21-Superset"
sha256: "<autogenerated>"
timestamp: "2025-10-21T22:00:00Z"
validated_by: "validate_toolagent_spec.py"

---

# 1. General Introduction

This document represents the **superset version** of the ToolAgent Specification, integrating and harmonizing:

* the formal ToolAgent version in `AGENTS.md` / `AGENTS2.md`
* clarifications regarding RBAC, cognitive bias, security, CI/CD, enforcement, and UN/NIST/WB standards
* the architectural and implementation design derived from the IQTB Gen-1/Gen-4 system
* the requirement of **Mandatory Web Verification** prior to any executive action

The sections are structured for compatibility with modules 01-06 of the original ToolAgent specification.

## 1.1 Spec Precedence (binding, ASCII-only)

1) ~/.codex/config.toml  (profiles + verify_loop + gates)
2) ToolAgent - 0X_* docs (Policy, Components, Enforcement, Semantics)
3) AGENTS.md
4) Runtime prompt

If a higher-level spec conflicts with a lower-level one, the higher-level spec prevails.

**Nota  Toolchain Guard (Fail-Closed SSoT)**
Il controllo `toolchain_exact_guard` utilizza la sezione `[guards.toolchain_exact_guard]` del file di configurazione SSoT (`config.toml`).
Parametri di default:
- `reference_config = "config.toml"`
- `allow_dual_guard = false`  *(fail-closed di default)*
- `dual_reference_config = "config.toml"`  *(utilizzato solo se `allow_dual_guard=true`)*

Il guard  caricato allavvio del ciclo di verifica (verify_loop) e applica la validazione della toolchain rispetto alla configurazione dichiarata nel profilo SSoT, garantendo isolamento e autosufficienza del profilo MIL-grade.



## Thematic Blocks and Modularization



### Hash SHA-256 Declaration (Expanded)
Each module's SHA-256 digest is explicitly computed by `validate_toolagent_spec.py` to ensure integrity and reproducibility.

| Ordine | File | SHA-256 |
|:------:|:-------------------------------------------|:------------------------------------------|
| 1 | ToolAgent - 01_Policy_and_Meta.md | 4ee14ce36c3c58104da4fa5896ff603e196fed15f16a7a38814137c7ccc2ebb1 |
| 2 | ToolAgent - 02_Components.md | 20477aba38d4483dc7bbdaff2874c7d8a9f5cbc6259e7620750d0b40afe3c214 |
| 3 | ToolAgent - 03_Enforcement.md | 7efd1bc66c2e6685f7df1432c73274c8d8ad12269d87a75b575ae26378d9f3d9 |
| 4 | ToolAgent - 04_Semantic_Rules_and_XRef.md | 03a8be43996c5f40a207d89ae4d46a557cffe0417ab178d7eebba9e5249aa581 |
| 5 | ToolAgent - 05_Appendices_and_Versioning.md | 224d5f94be4bb270e3a5e91585bd9d65ce93969990dc97e91b029511bb728970 |
| 6 | ToolAgent - 06_Cognitive_Bias_Prevention.yaml | 599e3662c39842b9f35c94aff95a80870ea42a0987075b1c557da94855460c7d |

| Ordine | Modulo | Stato | SHA-256 |
|--------|--------|-------|----------|
| 1 | ToolAgent - 01_Policy_and_Meta.md | incluso | autogen |
| 2 | ToolAgent - 02_Components.md | incluso | autogen |
| 3 | ToolAgent - 03_Enforcement.md | incluso | autogen |
| 4 | ToolAgent - 04_Semantic_Rules_and_XRef.md | incluso | autogen |
| 5 | ToolAgent - 05_Appendices_and_Versioning.md | incluso | autogen |
| 6 | ToolAgent - 06_Cognitive_Bias_Prevention.yaml | incluso | autogen |

Root: `./`
Config reference: `./ToolAgent - 06_Cognitive_Bias_Prevention.yaml`

---

# 2. Governance and Compliance

## 2.1 Access Control (RBAC)

* Compliant with NIST SP 800-53 AC-1-AC-6 and ISO/IEC 27001 A.5/A.6
* Centralized YAML registry (`infrastructure/audit/rbac.yaml`)
* Role segregation: `admin`, `reviewer`, `operator`
* Mandatory MFA, quarterly review, changelog audit

## 2.2 Auditability and Accountability

* Mandatory traces: `trace_id`, `user_id`, `event_id`, `decision_outcome`
* Log retention >= 400 days, SHA-256 hashing
* JSON logging (RFC 5424), SIEM-ready, immutable ledger

## 2.3 Change & Configuration Management

* CI/CD enforcement: lint, test, strict mypy, pip-audit, license-check
* Double approver policy; merge-block on violations
* Policy enforced by `validate_toolagent_spec.py`

## 2.4 Security, Privacy, and AI Safety

* TLS 1.3, KMS, secrets rotation <= 90 days, zero hardcoded credentials
* AI models: "model card" + bias testing + human fallback

## 2.5 Data Protection & Communication Security

* Mandatory TLS 1.3 for internal and external communications
* Encrypted storage using AES-256
* Environment segregation: build / test / production
* Data classification: PII / PHI per ISO/IEC 27701
* Retention policy <= 365 days for sensitive data

---

# 3. Enforcement Rules

## 3.1 Prohibited Placeholders

* Forbidden: `...`, `pass`, `TODO`, `NotImplementedError`, `FIXME`, `TBD`

## 3.2 Prohibited Magic Numbers/Strings

* Constants must only be defined via `bot_crypto.infrastructure.definitions.constants`

## 3.3 Enforced Loading Order

* Sequence: 01 -> 06. Each module inherits enforcement and cognitive rules

 Mandatory Decorator Sequence

* Order: `retry`, `audit`, `log`, `metrics`, `timeout`
* Decorators sourced from: `infrastructure.decorators`

## 3.5 Time Policy (UTC)
<!-- enforcement_tag: time_policy_utc -->

Objective:
Ensure temporal consistency and cross-version compatibility for all timestamps generated within the system.

Rule:
Every component that generates or manipulates timestamps must comply with the UTC reference defined in the config.toml file, under the key:

[time_policy]
preferred_utc = "timezone.utc"


Mandatory constraints:

The use of datetime.utcnow() or datetime.now() without explicitly specifying tz=timezone.utc (or an equivalent consistent with preferred_utc) is strictly prohibited.

It is forbidden to import or use from datetime import UTC when preferred_utc is set to "timezone.utc", and vice versa.

All timestamps must be serialized in full ISO-8601 format (.isoformat()) and must include timezone information (Z or +00:00).

Any manual timezone modification using .replace(tzinfo=...) must trigger a lint or build-time error.

Compliance is enforced via the utc_policy_guard and timestamp_utc_guard guards, which are mandatory in the CI/CD verification loop.

---

# 4. Cognitive Bias Prevention (UN/NIST/UNESCO 2025)

Applied through module `ToolAgent - 06_Cognitive_Bias_Prevention.yaml`

## Mechanisms:

1. **Contrarian Review**: antithetical validation of hypotheses
2. **Semantic Reframing**: semantic reassessment every 3 iterations
3. **Confidence Calibration**: output includes confidence level
4. **Auto-Falsification**: each proposal -> at least one mandatory counterexample
5. **Pattern Frequency Audit**: audit triggered for repetitions >= 3
6. **Knowledge Balance Ratio**: 60% consolidated / 40% exploratory
7. **Decision Traceability**: tagged as `verified/unverifiable`

---

# 5. Execution Specifications for Agent GPT

## 5.1 Constraints

* Mandatory enforcement: preset `codexx_agent_constraints`
* Python >= 3.13, pydantic v2, no side effects
* Decorators must be applied in the prescribed sequence
* Full typing (no `Any` allowed)

## 5.2 Logging/Observability


**Deprecation Note - Metrics Registry (SSoT)**  
Do not use `metrics_registry.yaml`. The effective registry is **code-based**:
- `src/bot_crypto/infrastructure/metrics/metrics_registry.py` (runtime SSoT)
- `src/bot_crypto/infrastructure/metrics/metrics_factory.py` (bootstrap/factory)
- `metrics_policy.yaml` (declarative policy)
- `config/data/global/command_event_metric_mapping.yaml` (command/event -> metric mapping)
Any reference to `metrics_registry.yaml` must be replaced with the paths above.

* Every execution must log `{trace_id, user_id, event_id}`
* Mandatory Prometheus metrics: `agent_cycle_latency_seconds{phase}` p50/p95/p99

## 5.3 Run Workflow

* CI: `mypy --strict`, `pytest`, `bandit`, `black`, `pylint`, `pip-audit`, `sbom`, `cosign`
* Merge blocked if: coverage <95%, decorators missing, or lint/test failures
* Mandatory execution of `hatch run lint && hatch run tests` prior to merge
* All changes logged in `audit/change_log.yaml`

---

# 6. Mandatory Web Verification Pre-Action

## Objective

Prevent execution based on outdated sources. Mandatory online verification required prior to:

* Use of languages, frameworks, SDKs, or APIs
* Generative or executive actions

## Binding Procedure


### Operational Procedure - Codex GPT
The following five steps define the operational enforcement workflow:
1. Read exclusively this orchestrator (AGENTS.md or its superset) as the authoritative source.
2. Apply "No placeholder / No magic number" enforcement across all files 01-06 and verify their SHA-256 digests.
3. Proceed with analysis or refactor only if all technical and cognitive validation blocks are valid.
4. Ensure that every generated output complies with the same enforcement constraints and includes `trace_id` and `event_id`.
5. Execute `validate_toolagent_spec.py` in CI/CD to block any merge in case of violations.

1. Targeted queries using keywords such as `latest`, `deprecation`, `breaking`, etc.
2. Source hierarchy: (a) SDO/standards; (b) official vendor documentation; (c) official repositories; (d) peer-reviewed papers; (e) third-party sources (support only)
3. Accepted content: updated within <12 months (general), <3 months (security-related)
4. Evidence: mandatory log with `Title, Source, URL, Publication Date, Access Date`
5. Decision: update plans/tools/flags if >= 1 element is outdated
6. Audit commit: include `Web Verification` section in the PR

## Fail-Closed Policy

* Offline -> execution blocked, explicit error
* Cache: maximum 24h (6h for security-related data); TTL invalidated on keyword triggers

## Mandatory Commit Template

### Web Verification (Mandatory)

* Query:
* Freshness outcome: [OK/KO]
* Evidence:

  1. Title - Source - URL - Published: YYYY-MM-DD - Accessed: YYYY-MM-DD
  2. ...

### Changes Due to Verification

* Updated versions/APIs:
* Detected deprecations:

## PR Gate Checklist


**Computable Documentation (CI Quality Gate)**  
- `docs/semantic_check/ci_quality_gate.md`  
- `docs/semantic_check/naming_glossary.md`  
These documents are integral to CI validation and must be referenced in validation reports and PR checklists.

* [ ] One official source + one independent source verified
* [ ] No use of deprecated APIs or standards
* [ ] Rollback plan defined

## Mandatory System Prompt

Before any action:

1. Verify on the web the freshness of versions/APIs/standards
2. Use official sources; record URLs, dates, and titles
3. If outdated -> update plan/flag/tool
4. If unverifiable -> refuse execution

---

# 7. Performance, Robustness, and SLO Metrics

## Computable SLI / SLO


### Metrics Policy - Mandatory Labels
All performance and observability metrics must include the following mandatory labels:
`trace_id`, `event_id`, `component`, `severity`, `latency_bucket`.
These labels ensure traceability across distributed executions and are enforced by Prometheus hooks and CI/CD audits.

* **Availability:** P(run_status=SUCCESS) >= 99.5% (rolling 30 days)
* **Latency p95 (phase=act):** <= 1.2s (alert if p95>1.2s for >10min)
* **Risk accuracy:** justified_kills / total_kills >= 0.98

## HPA/KEDA Autoscaling

* **Trigger metrics:** `queue_depth{topic}`, `latency_ms_p95`, `orders_tps`, `error_rate`
* **Supported topologies:** `single-tenant`, `multi-tenant`, `multi-region`
* **Resilience mechanisms:** circuit breaker, retry, failover, graceful degradation

## Agent: ToolAgent Runtime

**Config Reference:** `[agent.toolagent_runtime]`

- Endpoint: `https://runtime.api.toolagent.local/v1`
- Role: `orchestrator`
- Timeout: `1200 ms`
- Retry policy: `3` attempts with exponential backoff enforced by `retry  audit  log  metrics  timeout`
- Auth: OIDC client-credentials (`scope = trace:write, orders:read`)
- Secure transport: TLS 1.3 + certificate pinning

Input: JSON envelope `{trace_id, event_id, user_id, role_set, command, payload}` signed by `RiskEngine.pre_check`.

Output: Deterministic payload `{status, decision_outcome, metrics_ref, ledger_cursor}` plus Prometheus metric `agent_cycle_latency_seconds{phase,trace_id,event_id,component,severity,latency_bucket}`.

Protocol: HTTPS POST (RFC 9239 logging headers) with mutex-guarded retries.

Error: Critical violations emit `StrategyKillEvent` and trigger `KillExecutionProcess`; recoverable issues surface as `agent_error` with remediation hints.

### Example Usage - Public API `run(...)`
```python
from toolagent import ToolAgent
from uuid import uuid4

async def main():
    trace_id = str(uuid4())
    agent = ToolAgent()
    tools = ["orders_fetcher", "risk_checker"]
    roles = ["trader"]  # RBAC at orchestrator level
    result = await agent.run(
        "Run risk pre-check and fetch open orders",
        tools=tools,
        trace_id=trace_id,
        user_roles=roles,
    )
    print(result.final_output)
```
The example enforces: no-placeholder, explicit typing, RBAC, and sequential decorators (`retry -> audit -> log -> metrics -> timeout`).

* `RiskEngine.pre_check` executed at every step
* `KillExecutionProcess` triggered on severity=critical or after 3 consecutive failures
* Event flow: `ToolExecutedEvent`, `StrategyKillEvent`, `audit_trail_manager`
* JSON-based logging, append-only ledger, deterministic replay

## Agent: Audit Bridge

**Config Reference:** `[agent.audit_bridge]`

- Endpoint: `https://observability.api.toolagent.local/audit`
- Role: `audit_bridge`
- Timeout: `900 ms`
- Retry policy: `5` attempts with jitter; failures escalate into `PolicyBreachEvent`
- Auth: Mutual TLS (`scope = audit:append, audit:read`) backed by HSM-issued certificates
- Secure transport: TLS 1.3 with OCSP stapling; payloads encrypted at rest via AES-256

Input: Batched audit frames `[ {trace_id, event_id, span_id, decision_outcome, payload_sha256} ... ]` emitted by ToolExecutedEvent observers.

Output: Acknowledgement `{status, ledger_offset, siem_batch_id}` guaranteeing 400 day retention.

Protocol: HTTPS PUT with OpenTelemetry baggage propagation (`toolagent_id`, `session_id`).

Error: Transport failures flag the batch for retry and emit `PolicyBreachEvent` (severity=critical); schema conflicts reject with `409` and require operator review.

## Service: Risk Manager Proxy

**Config Reference:** `[service.risk_manager_proxy]`

- Endpoint: `https://risk.api.toolagent.local/precheck`
- Role: `risk_manager`
- Timeout: `750 ms`
- Retry policy: `2` attempts before invoking `KillExecutionProcess`
- Auth: OIDC service credential (`scope = risk:evaluate`)
- Secure transport: TLS 1.3 with client cert verification inside service mesh

Input: Trade-intent payload `{trace_id, event_id, symbol_id, leverage_request, exposure_snapshot}` produced by pre-deal hooks.

Output: Decision tuple `{status, allowed_leverage, risk_flags[], decision_outcome}` that gates the orchestrators execution path.

Protocol: HTTPS POST with deterministic JSON schema validated by `schemas/risk_card.schema.json`.

Error: Any `risk_flags` containing `critical` forces `StrategyKillEvent`; transient timeouts surface as `infra_error` and trigger retries with jitter.

---

# 8. ToolAgent Orchestration

## Architecture

* ReAct -> CQRS + EDA + Clean/Hex + DI Container
* Layers: Domain, Application, Infrastructure, Observability, Compliance
* Asynchronous interfaces: FastAPI, CLI, webhook, OpenAPI

## Plugins (Centralized Registration)


**Centralization Registry - Binding SSoT**  
Canonical path: `./src/bot_crypto/infrastructure/registry/centralization_registry.yaml`  
All shared components (logging, metrics, redis/pubsub, db, notifier, risk_center) **must** be resolved via `DIContainer` and tracked in this registry. Creating local instances or importing resources outside the SSoT mapping is forbidden.

* `exchange_adapter`, `risk_engine`, `regime_detector`, `strategy_engine`
* `plugin_ai_sentiment`, `plugin_risk_forecaster`, `plugin_alert_bridge`
* `post_trade_analyzer`, `dashboard_web`, `plugin_ml_optimizer`

## Symbol/Exchange-Aware Contracts

* Mandatory `symbol_id` in every command/event
* Redis topic structured as `symbol` and `exchange.symbol`
* Mutex control: single-writer, lease TTL, fence token
* Observability labels: `symbol`, `exchange`, `strategy`, `trace_id`

## CI/CD / Disaster Recovery

* Pipeline: Build -> Test -> Lint -> SBOM -> Sign -> Deploy
* Deployment strategies: canary, blue-green, rolling
* Validated RTO/RPO thresholds
* Automatic snapshot rollback mechanisms


---

# 9. Computable Compliance & Enforcement

* ToolAgent serves as the Single Source of Truth (SSoT) for computable enforcement, ensuring:

  * Complete typing coverage
  * No placeholders
  * Enforced decorators
  * Observability fields present
  * Computable metrics
  * Kill-switch on critical risk conditions
  * Enforced CI/CD policy compliance
  
---

# 10. End of Document

All modules, policies, presets, metrics, and cognitive mechanisms are validated through
`validate_toolagent_spec.py`, `metrics_policy.yaml`, `event_manifest.yaml`, `xref_map.yaml`, and the CI/CD pipeline.

---

Documentation compliant with World Bank 2025 directives, NIST SP 800-53, ISO/IEC 27001, and United Nations specifications for mission-critical software agents.

**APPENDIX**

preset_id: codexx_agent_constraints
version: "2025.07.07"
python_version: "3.13"
description: >
  Preset formale di validazione statica per enforcement computabile, CI/CD vincolata,
  sicurezza e auditabilita agentica secondo standard ONU/NIST/WB. Blocco vincolante
  per ogni istanza ToolAgent.
...
decorators:
  enforce_sequence:
    - retry
    - audit
    - log
    - metrics
    - timeout
  source_must_be: infrastructure.decorators
...
ci_simulation:
  run_mypy_strict: true
  run_pylint_min_score: 9.0
  run_bandit: true
  
  
testing:
  require_tests_for:
    - commands
    - events
  test_format: "AAA"
  coverage_min: 95

  
observability:
  log_fields_required:
    - trace_id
    - span_id
    - event_id
    - user_id
    - session_id
    - toolagent_id   # <- Aggiunto
    - timestamp
  log_levels_allowed:
    - DEBUG
    - INFO
    - WARNING
    - ERROR
    - CRITICAL
  metrics_required:
    - inference_latency_ms
    - total_tokens
    - input_tokens
    - output_tokens
    - prompt_type
    - error_category   # <- Aggiunto
  error_category_enum:
    - user_error
    - agent_error
    - infra_error
    - external_dependency_error
    - unknown_error

  
runtime:
  max_execution_time_seconds: 3
  fail_on_timeout: true


  
typing:
  enforce_return_type: true
  enforce_param_types: true
  allow_any: false

syntax:
  no_placeholders: true
  forbidden_patterns:
    - "\\bTODO\\b"
    - "\\.\\.\\."
    - "^\\s*pass\\s*(#.*)?$"
    - "\\bNotImplementedError\\b"
    - "\\b(?:FIXME|TBD)\\b"
	- "^\\s*#\\s*(NOTE|BUG|ISSUE)\\b"
    - "^\\s*'''\\s*Example.*'''"

staticmethods:
  require_for_non_self_methods: true
protocols:
  require_runtime_checkable: true
naming:
  ascii_only: true
  class_format: PascalCase
  file_format: snake_case
  no_stdlib_shadowing: true
  allow_only_registry_names: true
  forbid_duplicate_names: true
  block_generic_suffixes: ["Handler", "Manager", "Tool"]
structure:
  enforce_no_side_effects_on_import: true
  immutable_data_structures: true
metaclass_control:
  forbid_dynamic_class_generation: true
  allow_only_known_metaclasses: true
module_exports:
  require_explicit_all: true
pydantic:
  version: ">=2.0"
  enforce_model_config:
    - frozen
    - extra=forbid
validation:
  require_input_schema: true
  schema_types: ["TypedDict", "PydanticModel"]
preconditions:
  fallback_allowed_if:
    - fallback_module_configured == true
    - decorators_compliant == true
    - owner_id_present == true
criticality_levels:

* id: critical
  description: |
  Components that, if malfunctioning or altered, may cause immediate impacts on capital, compliance, or system integrity.
  enforcement:
  web_verification: mandatory
  redundant_check: 2x validator
  runtime_supervision: required
  audit_log_level: full
  deploy_gate: manual_approval_only

* id: blocking
  description: |
  Components whose malfunction halts workflows but does not cause immediate damage. They must be resilient and self-contained.
  enforcement:
  web_verification: mandatory
  runtime_supervision: recommended
  audit_log_level: normal
  deploy_gate: automated_with_review

* id: soft_guideline
  description: |
  Non-binding guidelines and recommendations. Codex may override them when justification and declared fallback are provided.
  enforcement:
  web_verification: optional
  audit_log_level: minimal

privileged_modules:

* name: order_executor
  criticality: critical
  justification: |
  Executes real orders in live markets. Must be auditable, deterministically traceable, and race-condition resistant.
  signature_required: true
  zero_trust_required: true

* name: risk_manager
  criticality: critical
  justification: |
  Calculates leverage and exposure, and blocks hazardous operations. Errors or omissions compromise total capital.
  signature_required: true
  supervision_required: true

* name: leverage_controller
  criticality: blocking
  justification: |
  Dynamically adjusts leverage based on volatility. Errors halt the strategy but do not cause immediate damage.
  rollback_capable: true

* name: strategy_reloader
  criticality: soft_guideline
  justification: |
  Support module updating AI-driven strategies. May fail without causing direct harm.
  fallback_allowed: true

enforcement:
web_verification: mandatory
audit_log_level: full
log_level: full | normal | minimal
fallback_strategy: notify_only | disable_module | retry_after_delay
---

# 11. Self-Optimization & Continuous Enforcement (Binding)

The orchestrator SHALL implement a continuous **PlanDoCheckAct** loop with rollback and computable gates:
- **Plan:** derive an actionable plan from policy modules 0106 and profile chain.
- **Do:** execute only after **Mandatory Web Verification** has passed (TTL-aware).
- **Check:** assert CI gates (lint, tests 95% coverage, type-check strict, SBOM, license).
- **Act:** auto-generate a delta patch and a Markdown report; revert on regression.

**Computable Outputs (Mandatory):**
- `reports/autoimprove.patch` (unified diff)
- `docs/codex_autoimprove.md` (sections: executed_actions, quality_gates, metrics_snapshot, residual_todos, recommended_next_steps)

# 12. Resource Control Policy (Budget & Quotas)

The agent SHALL respect explicit resource ceilings:
- Monetary budget per run and per hour
- Max requests per hour
- Max tokens per request
- Throttle strategy (token-bucket)

Violations trigger `PolicyBreachEvent` and **fail-closed** behavior unless `soft_guideline` is declared with justification.

# 13. Profile Resolution Chain

Profiles are resolved using a **deterministic inheritance chain**:
1) `profiles.default`
2) explicit profile(s) (left-to-right)
3) inline overrides (lowest precedence)

Conflicts are resolved by the highest-precedence profile. Runtime prompts NEVER override 0106 modules.

# 14. Fail-Closed & TTL Enforcement

When `Mandatory Web Verification` is active, the agent MUST:
- Enforce TTLs: 24h default; 6h for security-sensitive checks.
- Fail-closed if web verification is unavailable or stale beyond TTL.
- Record **evidence**: Title, Source, URL, Published, Accessed.

**Pseudocode (computable):**
```
if now - last_web_verification > TTL:
    block("Web verification stale")
if web_check == FAIL:
    block("Web unavailable (fail-closed)")
```

# 15. Observability Labels (Expanded, Binding)

All metrics MUST include labels:
`trace_id`, `event_id`, `component`, `severity`, `latency_bucket`, `prompt_type` (if applicable).

Logs MUST include at least:
`trace_id`, `span_id`, `event_id`, `user_id`, `session_id`, `toolagent_id`, `timestamp`, `decision_outcome`.

# 16. Criticality Mapping & Privileged Modules (Operational)

Each tool/module SHALL be assigned a **criticality level**:
- `critical`  web_verification: mandatory; runtime_supervision: required; manual deploy gate.
- `blocking`  web_verification: mandatory; automated_with_review.
- `soft_guideline`  web_verification: optional; minimal audit.

A computable registry MUST exist and be validated in CI.

# 17. Autoscaling/HPA Policy (Declarative)

KEDA/HPA triggers SHALL be derived from metrics:
- `queue_depth{topic}`, `latency_ms_p95`, `orders_tps`, `error_rate`

Scaling policies MUST declare topologies (single-tenant, multi-tenant, multi-region) and guardrails (circuit-breaker, graceful degradation).

# 18. Cross-Reference to Configuration (Normative)

This spec is the **authoritative source** for:
- Bias prevention toggles (contrarian_review, auto_falsification, confidence_calibration)
- TTL policy for web verification
- Mandatory observability labels and log fields
- Profile resolution and budget ceilings

The runtime configuration SHALL reflect these requirements in `~/.codex/config.toml`.

---

# 19. RBAC & Governance (Computable, Binding)
- Roles: `admin`, `reviewer`, `operator`; MFA obbligatoria; audit trail con retention 400 giorni (RFC 5424 JSON).
- Ogni decisione deve includere `decision_outcome` nei log e deve essere riferibile a `trace_id` ed `event_id`.
- CI richiede **double-approver policy** e `merge_gate=strict`; blocco se violati i quality gates.

# 20. Decorator Source & Sequence (Binding)
I decorator **devono** provenire da `infrastructure.decorators` e rispettare lordine:
`retry  audit  log  metrics  timeout`. Le violazioni sono bloccanti a livello CI/CD.

# 21. Legacy/Deprecation Policy (Binding)
- Vietato luso di `metrics_registry.yaml` legacy; SSoT: `metrics_registry.py` e `metrics_factory.py`.
- Ogni riferimento legacy rilevato attiva `DeprecationViolation` e blocco merge.

# 22. Placeholder & Magic Numbers (Binding)
- Vietati: `TODO`, `FIXME`, `NotImplementedError`, `TBD`, `...`, `pass` su riga, e tag commento `NOTE|BUG|ISSUE` usati come segnaposto.
- Magic numbers/strings fuori da `constants` sono proibiti.

# 23. Kill-Switch & Circuit-Breaker (Operational)
- Il runtime deve esporre un **kill-switch** computabile con escalation su severit `critical` e fence token per single-writer.
- Gli eventi devono essere tracciati (`StrategyKillEvent`, `ToolExecutedEvent`) con replay deterministico nellaudit trail.

# 24. Evidence & Web Verification TTL (Binding)
- TTL: 24h generale, 6h sicurezza. In caso di scadenza o indisponibilit della verifica web  **fail-closed**.
- Evidenze minime: *Title, Source, URL, Published, Accessed*; inserire nella sezione *Web Verification* del template PR.

# 25. Testing & Coverage (Binding)
- Copertura **95%**; test formato AAA per comandi/eventi; `mypy --strict`, `pylint` score minimo **9.0**.

# 26. Autoscaling & Resilience (Binding)
- KEDA/HPA triggers: `queue_depth{topic}`, `latency_ms_p95`, `orders_tps`, `error_rate`.
- Guardrail: circuit-breaker, graceful degradation, retry/backoff a livelli, failover.

# 27. Privileged Modules  Criticality Levels
- `order_executor`  `critical` (manual deploy gate, web verification mandatory).
- `risk_manager`  `critical` (supervision required).
- `leverage_controller`  `blocking` (rollback-capable).

---

## Computable Schema
- This specification SHALL be validated against `schemas/agents.schema.json`.
- The runtime configuration SHALL be validated against `schemas/config.schema.json` via CI(Policy-as-Code).

---

## Business Continuity & Runbook (Binding)
- **RTO**: 60 min; **RPO**: 15 min. 
- **Escalation**: Operator  Reviewer  Admin; risposta in 15/30/60 min.
- **Emergency Override**: finestra max come da `emergency_policy`; approvazione firmata, audit trail obbligatorio.
- **Rollback**: golden image firmata, `cosign` verify prima del deploy.
- **Runbook**: playbook per fail-closed prolungato, recovery cache evidenze, switch a profilo *stage* con gate ridotti previa approvazione.

### Cognitive Safety Metrics Export (OpenMetrics)
- Esportare `codex_contrarian_ratio`, `codex_counterexamples_total` per profilo/ambiente.
- Obbligo di report settimanale con trend e remediation plan se sotto soglia.

---

## Model & Risk Cards (Binding)
- Ogni modello/profilo deve avere una **Model Card** conforme a `schemas/model_card.schema.json`.
- Ogni componente critico deve avere una **Risk Card** conforme a `schemas/risk_card.schema.json`.
- La matrice RischioPolicy deve mappare livelli `low/medium/high/critical` su: deploy gate, supervision, rollback, web verification, approval policy.

### Cognitive Safety Remediation (Binding)
- Soglie per ambiente: dev/test 0.05, stage 0.10, prod 0.20 su `contrarian_ratio`.
- Se sotto soglia per 2 report consecutivi: aprire ticket con **remediation plan** e controrisposte obbligatorie.

---

## Security & Telemetry Artifacts (Binding)
- **SARIF**: `reports/security.sarif` MUST be produced and archived per release.
- **OTEL attributes**: `policies/otel_attrs.yaml` MUST be present and loaded at startup.
- **OpenMetrics**: `reports/metrics.prom` MUST be published by CI with cognitive safety KPIs.

---

## Conformance (Binding)
- **SARIF**: `reports/security.sarif` MUST conform to SARIF 2.1.0 (fields `version`, `runs[]`). CI blocks on invalid schema.
- **OTEL attributes**: `policies/otel_attrs.yaml` MUST include minimally `service.name`, `service.version`, `ai.system`. CI blocks if missing.
- **OpenMetrics**: `reports/metrics.prom` MUST expose `codex_contrarian_ratio` (gauge) e counters KPI bias. CI blocks on format errors.

---

## Bias Automatic Remediation (Binding)
- Se `contrarian_ratio` < soglia ambiente: **deploy bloccato** fino a inserimento `reports/human_supervision_ticket.txt` con ID ticket valido o esecuzione rollback.
- La supervisione deve essere tracciata in audit trail con `decision_outcome` e referenza al ticket.

OpenAI SDK Contract (Binding)

Input schema (Responses API): responses.create(...) deve ricevere input: str oppure input: List[Message] con content parts tipizzati ({"type":"input_text","text": ...}); vietato {"role":"user","content":"<str>"}.

Timeout: vietato passare timeout= a responses.create; il timeout  obbligatorio sul client (OpenAI().with_options(timeout=...)).

Parsing:  obbligatorio usare resp.output_text come via primaria; fallback ammesso solo via resp.model_dump() con filtro item.type == "message".

Union safety: vietato laccesso diretto a resp.output[...].content[...] (union-attr).

Eccezioni: vietati except: e except Exception:. Gestire classi specifiche (p.es. RateLimitError, APIConnectionError, APIStatusError, APITimeoutError) e retry solo su errori transienti.

Computability: la conformit  verificata dai guard openai_api_schema_guard, openai_client_timeout_guard, responses_union_attr_guard, broad_except_guard; violazione  merge-block.
